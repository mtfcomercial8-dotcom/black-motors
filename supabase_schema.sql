-- --- INSTRUÇÕES IMPORTANTES ---
-- 1. Copie todo este conteúdo.
-- 2. Vá no painel do Supabase (SQL Editor).
-- 3. Cole e clique em "RUN".
-- ------------------------------

-- 1. Cria a tabela se ela ainda não existir
create table if not exists public.reservations (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  name text not null,
  phone text not null,
  date text not null,
  time text not null,
  guests text not null,
  type text not null, -- 'reserva' ou 'encomenda'
  status text default 'pendente',
  notes text
);

-- 2. Garante permissões básicas (GRANTS)
-- Isso é vital para que o usuário 'anon' (o site sem login) consiga acessar a tabela e o gerador de IDs
grant usage on schema public to anon, authenticated;
grant all on table public.reservations to anon, authenticated;
grant usage, select on sequence public.reservations_id_seq to anon, authenticated;

-- 3. Configura a Segurança (Row Level Security)
alter table public.reservations enable row level security;

-- 4. Limpa regras antigas que podem estar bloqueando (DROP)
-- Removemos todas as variações de nomes possíveis para evitar conflitos
drop policy if exists "Enable insert for everyone" on public.reservations;
drop policy if exists "Enable full access for authenticated users" on public.reservations;
drop policy if exists "Enable select for everyone" on public.reservations;
drop policy if exists "Enable update for everyone" on public.reservations;
drop policy if exists "Universal Access Policy" on public.reservations;
drop policy if exists "Public Access" on public.reservations;
drop policy if exists "Enable all for everyone" on public.reservations;
drop policy if exists "Allow public insert" on public.reservations;

-- 5. Cria a REGRA DE OURO (Permitir Tudo)
-- Esta regra diz: "Permitir qualquer operação (all) para qualquer pessoa (public)"
-- "using (true)" permite ler qualquer linha
-- "with check (true)" permite escrever/editar qualquer linha
create policy "Universal Access Policy"
on public.reservations
for all
to public
using (true)
with check (true);

-- Confirmação visual
select 'Permissões corrigidas com sucesso! Tente fazer a reserva novamente.' as mensagem;